// COPYRIGHT Dassault Systemes 2011
//===================================================================
//
// MBDPrtAddMaterialDlg.cpp
// The dialog : MBDPrtAddMaterialDlg
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  Feb 2011  Creation: Code generated by the CAA wizard  ev5adm
//===================================================================
#include "MBDPrtAddMaterialDlg.h"
#include "CATApplicationFrame.h"
#include "CATDlgGridConstraints.h"
#include "CATMsgCatalog.h"
#ifdef MBDPrtAddMaterialDlg_ParameterEditorInclude
#include "CATIParameterEditorFactory.h"
#include "CATIParameterEditor.h"
#include "CATICkeParm.h"
#endif

const int MAXCOUNT = 6;



//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
MBDPrtAddMaterialDlg::MBDPrtAddMaterialDlg() :
  CATDlgDialog ((CATApplicationFrame::GetApplicationFrame())->GetMainWindow(),
//CAA2 WIZARD CONSTRUCTOR DECLARATION SECTION
"MBDPrtAddMaterialDlg",CATDlgWndBtnClose|CATDlgGridLayout
//END CAA2 WIZARD CONSTRUCTOR DECLARATION SECTION
                               )
{
//CAA2 WIZARD CONSTRUCTOR INITIALIZATION SECTION
 _Frame001 = NULL;
 _Frame002 = NULL;
 _SearchCombo01 = NULL;
 _SearchCombo02 = NULL;
 _SearchCombo03 = NULL;
 _SearchCombo04 = NULL;
 _SearchCombo05 = NULL;
 _SearchCombo06 = NULL;
 _Label01 = NULL;
 _Label02 = NULL;
 _Label03 = NULL;
 _Label04 = NULL;
 _Label05 = NULL;
 _Label06 = NULL;
 _ContentEditor = NULL;
 _LabelContent = NULL;
 _SearchPB = NULL;
 _Label07 = NULL;
 _Label08 = NULL;
 _Label09 = NULL;
 _Frame003 = NULL;
 _ResultML = NULL;
 _ResultDetailEditor = NULL;
 _Frame007 = NULL;
 _AddMainMaterialPB = NULL;
 _AddAuxiliaryMaterialPB = NULL;
//END CAA2 WIZARD CONSTRUCTOR INITIALIZATION SECTION

 //初始化属性显示名称
 m_lstStrPropertyName[0]=CATUnicodeString("材料标识");
 m_lstStrPropertyName[1]=CATUnicodeString("材料大类别");
 m_lstStrPropertyName[2]=CATUnicodeString("材料小类别");
 m_lstStrPropertyName[3]=CATUnicodeString("材料名称");
 m_lstStrPropertyName[4]=CATUnicodeString("材料牌号");
 m_lstStrPropertyName[5]=CATUnicodeString("材料技术条件"); 
 m_lstStrPropertyName[6]=CATUnicodeString("供应状态");
 m_lstStrPropertyName[7]=CATUnicodeString("品种");
 m_lstStrPropertyName[8]=CATUnicodeString("品种代号");
 m_lstStrPropertyName[9]=CATUnicodeString("材料规格");
 m_lstStrPropertyName[10]=CATUnicodeString("品种技术条件");
 m_lstStrPropertyName[11]=CATUnicodeString("进口或新材料");
 m_lstStrPropertyName[12]=CATUnicodeString("抗拉强度");
 m_lstStrPropertyName[13]=CATUnicodeString("伸长率");
 m_lstStrPropertyName[14]=CATUnicodeString("密度单位");
 m_lstStrPropertyName[15]=CATUnicodeString("密度公差");
 m_lstStrPropertyName[16]=CATUnicodeString("密度");
 m_lstStrPropertyName[17]=CATUnicodeString("材质颜色");
 m_lstStrPropertyName[18]=CATUnicodeString("应用型号");
 m_lstStrPropertyName[19]=CATUnicodeString("备注");

}

//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
MBDPrtAddMaterialDlg::~MBDPrtAddMaterialDlg()
{
//  Do not delete the control elements of your dialog: 
//     this is done automatically
//  --------------------------------------------------
//CAA2 WIZARD DESTRUCTOR DECLARATION SECTION
 _Frame001 = NULL;
 _Frame002 = NULL;
 _SearchCombo01 = NULL;
 _SearchCombo02 = NULL;
 _SearchCombo03 = NULL;
 _SearchCombo04 = NULL;
 _SearchCombo05 = NULL;
 _SearchCombo06 = NULL;
 _Label01 = NULL;
 _Label02 = NULL;
 _Label03 = NULL;
 _Label04 = NULL;
 _Label05 = NULL;
 _Label06 = NULL;
 _ContentEditor = NULL;
 _LabelContent = NULL;
 _SearchPB = NULL;
 _Label07 = NULL;
 _Label08 = NULL;
 _Label09 = NULL;
 _Frame003 = NULL;
 _ResultML = NULL;
 _ResultDetailEditor = NULL;
 _Frame007 = NULL;
 _AddMainMaterialPB = NULL;
 _AddAuxiliaryMaterialPB = NULL;
//END CAA2 WIZARD DESTRUCTOR DECLARATION SECTION
}



void MBDPrtAddMaterialDlg::Build()
{
//  TODO: This call builds your dialog from the layout declaration file
//  -------------------------------------------------------------------

//CAA2 WIZARD WIDGET CONSTRUCTION SECTION
 SetGridRowResizable(0,1);
 SetGridColumnResizable(0,1);
 _Frame001 = new CATDlgFrame(this, "Frame001", CATDlgFraNoFrame|CATDlgGridLayout);
_Frame001 -> SetGridConstraints(0, 0, 1, 1, CATGRID_4SIDES);
 _Frame001 -> SetGridRowResizable(0,1);
 _Frame001 -> SetGridColumnResizable(1,1);
 _Frame002 = new CATDlgFrame(_Frame001, "Frame002", CATDlgGridLayout);
_Frame002 -> SetGridConstraints(0, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo01 = new CATDlgCombo(_Frame002, "SearchCombo01", CATDlgCmbDropDown);
_SearchCombo01 -> SetGridConstraints(0, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo02 = new CATDlgCombo(_Frame002, "SearchCombo02", CATDlgCmbDropDown);
_SearchCombo02 -> SetGridConstraints(2, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo03 = new CATDlgCombo(_Frame002, "SearchCombo03", CATDlgCmbDropDown);
_SearchCombo03 -> SetGridConstraints(4, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo04 = new CATDlgCombo(_Frame002, "SearchCombo04", CATDlgCmbDropDown);
_SearchCombo04 -> SetGridConstraints(6, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo05 = new CATDlgCombo(_Frame002, "SearchCombo05", CATDlgCmbDropDown);
_SearchCombo05 -> SetGridConstraints(8, 0, 1, 1, CATGRID_4SIDES);
 _SearchCombo06 = new CATDlgCombo(_Frame002, "SearchCombo06", CATDlgCmbDropDown);
_SearchCombo06 -> SetGridConstraints(10, 0, 1, 1, CATGRID_4SIDES);
 _Label01 = new CATDlgLabel(_Frame002, "Label01");
_Label01 -> SetGridConstraints(1, 0, 1, 1, CATGRID_4SIDES);
 _Label02 = new CATDlgLabel(_Frame002, "Label02");
_Label02 -> SetGridConstraints(3, 0, 1, 1, CATGRID_4SIDES);
 _Label03 = new CATDlgLabel(_Frame002, "Label03");
_Label03 -> SetGridConstraints(5, 0, 1, 1, CATGRID_4SIDES);
 _Label04 = new CATDlgLabel(_Frame002, "Label04");
_Label04 -> SetGridConstraints(7, 0, 1, 1, CATGRID_4SIDES);
 _Label05 = new CATDlgLabel(_Frame002, "Label05");
_Label05 -> SetGridConstraints(9, 0, 1, 1, CATGRID_4SIDES);
 _Label06 = new CATDlgLabel(_Frame002, "Label06");
_Label06 -> SetGridConstraints(11, 0, 1, 1, CATGRID_4SIDES);
 _ContentEditor = new CATDlgEditor(_Frame002, "ContentEditor");
 _ContentEditor -> SetVisibleTextWidth(15);
_ContentEditor -> SetGridConstraints(13, 0, 1, 1, CATGRID_4SIDES);
 _LabelContent = new CATDlgLabel(_Frame002, "LabelContent");
_LabelContent -> SetGridConstraints(12, 0, 1, 1, CATGRID_4SIDES);
 _SearchPB = new CATDlgPushButton(_Frame002, "SearchPB");
_SearchPB -> SetGridConstraints(17, 0, 1, 1, CATGRID_4SIDES);
 _Label07 = new CATDlgLabel(_Frame002, "Label07");
_Label07 -> SetGridConstraints(14, 0, 1, 1, CATGRID_4SIDES);
 _Label08 = new CATDlgLabel(_Frame002, "Label08");
_Label08 -> SetGridConstraints(15, 0, 1, 1, CATGRID_4SIDES);
 _Label09 = new CATDlgLabel(_Frame002, "Label09");
_Label09 -> SetGridConstraints(16, 0, 1, 1, CATGRID_4SIDES);
 _Frame003 = new CATDlgFrame(_Frame001, "Frame003", CATDlgGridLayout);
_Frame003 -> SetGridConstraints(0, 1, 1, 1, CATGRID_4SIDES);
 _Frame003 -> SetGridRowResizable(0,1);
 _Frame003 -> SetGridColumnResizable(0,1);
 _ResultML = new CATDlgMultiList(_Frame003, "ResultML");
 /*CATUnicodeString ResultMLTitles [ 21 ];
 ResultMLTitles[0] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle1");
 ResultMLTitles[1] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle2");
 ResultMLTitles[2] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle3");
 ResultMLTitles[3] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle4");
 ResultMLTitles[4] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle5");
 ResultMLTitles[5] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle6");
 ResultMLTitles[6] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle7");
 ResultMLTitles[7] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle8");
 ResultMLTitles[8] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle9");
 ResultMLTitles[9] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle10");
 ResultMLTitles[10] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle11");
 ResultMLTitles[11] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle12");
 ResultMLTitles[12] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle13");
 ResultMLTitles[13] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle14");
 ResultMLTitles[14] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle15");
 ResultMLTitles[15] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle16");
 ResultMLTitles[16] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle17");
 ResultMLTitles[17] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle18");
 ResultMLTitles[18] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle19");
 ResultMLTitles[19] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle20");
 ResultMLTitles[20] = CATMsgCatalog::BuildMessage("MBDPrtAddMaterialDlg", "Frame001.Frame003.ResultML.ColumnTitle21");*/
 _ResultML -> SetColumnTitles(MAXPROPERTYINDEX, m_lstStrPropertyName);
 _ResultML -> SetVisibleColumnCount( 15 );
_ResultML -> SetGridConstraints(0, 0, 1, 1, CATGRID_4SIDES);
 _ResultDetailEditor = new CATDlgEditor(_Frame003, "ResultDetailEditor", CATDlgEdtMultiline|CATDlgEdtReadOnly);
 _ResultDetailEditor -> SetVisibleTextHeight(20);
 _ResultDetailEditor -> SetVisibleTextWidth(40);
_ResultDetailEditor -> SetGridConstraints(1, 0, 1, 1, CATGRID_4SIDES);
 _Frame007 = new CATDlgFrame(_Frame003, "Frame007", CATDlgFraNoFrame|CATDlgGridLayout);
_Frame007 -> SetGridConstraints(2, 0, 1, 1, CATGRID_4SIDES);
 _Frame007 -> SetGridRowResizable(0,1);
 _Frame007 -> SetGridColumnResizable(0,1);
 _AddMainMaterialPB = new CATDlgPushButton(_Frame007, "AddMainMaterialPB");
_AddMainMaterialPB -> SetGridConstraints(0, 1, 1, 1, CATGRID_RIGHT|CATGRID_TOP|CATGRID_BOTTOM);
 _AddAuxiliaryMaterialPB = new CATDlgPushButton(_Frame007, "AddAuxiliaryMaterialPB");
_AddAuxiliaryMaterialPB -> SetGridConstraints(0, 0, 1, 1, CATGRID_RIGHT|CATGRID_TOP|CATGRID_BOTTOM);
//END CAA2 WIZARD WIDGET CONSTRUCTION SECTION


//隐藏所有Label
_Label01->SetVisibility(CATDlgHide);
_Label02->SetVisibility(CATDlgHide);
_Label03->SetVisibility(CATDlgHide);
_Label04->SetVisibility(CATDlgHide);
_Label05->SetVisibility(CATDlgHide);
_Label06->SetVisibility(CATDlgHide);
_Label07->SetVisibility(CATDlgHide);
_Label08->SetVisibility(CATDlgHide);
_Label09->SetVisibility(CATDlgHide);

//
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_MATERIAL_CLASS_BIG");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_MATERIAL_CLASS_SMALL");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_MATERIAL_NAME");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_MATERIAL_TEC_CONDITION");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_SUPPLY_STATUS");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_TYPE");
m_alsStrCurrentWBSItem.Append("MATERIAL_INFO_MATERIAL_MARK");


//初始化显示界面
CATUnicodeString strComboName01(" 请选择： < “材料大类别” >");
CATUnicodeString strComboName02(" 请选择： < “材料小类别” >");
CATUnicodeString strComboName03(" 请选择： < “材料名称” >");
CATUnicodeString strComboName04(" 请选择： < “材料技术条件” >");
CATUnicodeString strComboName05(" 请选择： < “供应状态” >");
CATUnicodeString strComboName06(" 请选择： < “品种” >");
m_alsStrCurrentWBSShow.Append(strComboName01);
m_alsStrCurrentWBSShow.Append(strComboName02);
m_alsStrCurrentWBSShow.Append(strComboName03);
m_alsStrCurrentWBSShow.Append(strComboName04);
m_alsStrCurrentWBSShow.Append(strComboName05);
m_alsStrCurrentWBSShow.Append(strComboName06);

//加入所有COMBO到列表中
m_ItemComboList.Append(_SearchCombo01);
m_ItemComboList.Append(_SearchCombo02);
m_ItemComboList.Append(_SearchCombo03);
m_ItemComboList.Append(_SearchCombo04);
m_ItemComboList.Append(_SearchCombo05);
m_ItemComboList.Append(_SearchCombo06);
//
m_ItemComboList.Append(_ResultDetailEditor);
//

//
for (int i=1; i<=MAXCOUNT; i++)
{
	((CATDlgCombo*)m_ItemComboList[i])->SetLine(m_alsStrCurrentWBSShow[i]);
	((CATDlgCombo*)m_ItemComboList[i])->SetVisibleTextHeight(20);
}

//
//显示COMBO控件下拉框信息
for (int i = 1; i <= m_ItemComboList.Size()-1; i ++)
{
	CATListValCATUnicodeString astrKeyWords;

	CATUnicodeString strWBSItem = CATUnicodeString("DropdownList=") + m_alsStrCurrentWBSItem[i];
	astrKeyWords.Append(strWBSItem);

	SetSearchItemComboList(astrKeyWords,(CATDlgCombo*)m_ItemComboList[i]);
}

//
for (int i = 1; i <= MAXCOUNT; i ++)
{
	AddAnalyseNotificationCB ((CATDlgCombo*)m_ItemComboList[i],((CATDlgCombo*)m_ItemComboList[i])->GetComboSelectNotification(),
		(CATCommandMethod)&MBDPrtAddMaterialDlg::ComboItemSearchCB,NULL);
}


//CAA2 WIZARD CALLBACK DECLARATION SECTION
//END CAA2 WIZARD CALLBACK DECLARATION SECTION

}


CATBoolean MBDPrtAddMaterialDlg::ComboItemSearchCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//获得当前combo列表位置
	int comboIndex = m_ItemComboList.Locate(cmd);
	cout<<"用户点选的是"<<comboIndex<<endl;

	//搜索关键字列表
	CATLISTV(CATUnicodeString) aStrComboItemSelected;
	aStrComboItemSelected.Append(""); //添加一个空字符，占住位置，后面再修改它

	//获取搜索之前的COMBO的所有选择参数
	//采用循环方式
	for (int i = 1; i <= comboIndex; i++)
	{
		int tempIndex;
		tempIndex = ((CATDlgCombo*)m_ItemComboList[i])->GetSelect();

		if (tempIndex != 0)
		{
			CATUnicodeString strTempIndexItem ;
			((CATDlgCombo*)m_ItemComboList[i])->GetLine(strTempIndexItem,tempIndex);

			//构造赋值形式的字符串
			CATUnicodeString strTemp = m_alsStrCurrentWBSItem[i] + "=" + strTempIndexItem;
			aStrComboItemSelected.Append(strTemp);
		}

	}

	//更新选择该COMBO之后的COMBO的显示情况
	//减去1的原因，最后一个为EDITOR指针，非combo
	for (int j = comboIndex+1; j <= m_ItemComboList.Size() - 1; j++)
	{
		CATUnicodeString strSearch = CATUnicodeString("DropdownList=") + m_alsStrCurrentWBSItem[j];
		aStrComboItemSelected[1] = strSearch;

		//调用函数清除并添加新内容
		((CATDlgCombo*) m_ItemComboList[j])->ClearLine();
		CATUnicodeString strComboName = m_alsStrCurrentWBSShow[j];
		((CATDlgCombo*) m_ItemComboList[j])->SetLine(strComboName);
		HRESULT hr = SetSearchItemComboList(aStrComboItemSelected,(CATDlgCombo*)m_ItemComboList[j]);
	}

	return TRUE;
}

//============================================================
// [4/27/2011 ev5adm]
// 设置搜索条件combo下拉框的显示内容
//============================================================
HRESULT MBDPrtAddMaterialDlg::SetSearchItemComboList(CATListValCATUnicodeString astrKeyWords,CATDlgCombo * piDlgCombo)
{
	HRESULT hr = S_OK;
	//清空
	//存储搜索得到的combo value 
	CATListValCATUnicodeString strListOfSearchResult;
	CATListValCATUnicodeString astrCombolistValue;
	//调用查询接口
	hr = MBDWebservice::QueryDataWebService(astrKeyWords,strListOfSearchResult);

	//过滤需要的信息
	if (SUCCEEDED(hr))
	{
		//获得数据条目，及每条目数据个数，分别对应第二、第三，数据内容从第六条开始
		CATUnicodeString strCount=strListOfSearchResult[2];
		CATUnicodeString strCutNumb=strListOfSearchResult[3];
		double dCount=0,dCutNumb=1;
		strCount.ConvertToNum(&dCount);
		strCutNumb.ConvertToNum(&dCutNumb);

		//计算以3为倍数的循环次数
		int cyclecount = (int)((strListOfSearchResult.Size()-5)/dCutNumb);
		//
		if (cyclecount==dCount && dCutNumb==1)
		{
			if (cyclecount >= 1)
			{

				for (int i = 1; i <= cyclecount; i++)
				{
					astrCombolistValue.Append(strListOfSearchResult[i+5]);
				}

			}
		}
	}

	//////////////////////////////////////////////////////////////////////////
	//显示在combo下拉列表中
	for (int j = 1; j <= astrCombolistValue.Size(); j++)
	{
		piDlgCombo->SetLine(astrCombolistValue[j]);
	}

	return hr;
}

//获取所有WBSItem信息
void MBDPrtAddMaterialDlg::GetAllWBSItemInfo(CATLISTV(CATUnicodeString) &listStrSearchItems)
{
	//获取所选查询库信息
	CATUnicodeString strDatabase("");
	strDatabase = CATUnicodeString("DatabaseName=MATERIAL_INFO"); 
	listStrSearchItems.Append(strDatabase);

	//获取所有设置信息
	int count = m_ItemComboList.Size();

	for (int i = 1; i <= count-1; i ++)
	{
		int selectComboItem = ((CATDlgCombo*) m_ItemComboList[i])->GetSelect();

		if (selectComboItem != 0)
		{
			CATUnicodeString strComboValue("");
			((CATDlgCombo*) m_ItemComboList[i])->GetLine(strComboValue,selectComboItem);

			CATUnicodeString strValue("");
			strValue = m_alsStrCurrentWBSItem[i] + "=" + strComboValue;
			listStrSearchItems.Append(strValue);
		}


	}

	// Append Editor Values
	CATUnicodeString strEditorValue("");
	strEditorValue = ((CATDlgEditor*) m_ItemComboList[count])->GetText();
	if (strEditorValue != "")
	{
		strEditorValue = m_alsStrCurrentWBSItem[count] + "=" + strEditorValue;
		listStrSearchItems.Append(strEditorValue);
	}
	/*else
	{
		strEditorValue = m_alsStrCurrentWBSItem[count] + "=########";
		listStrSearchItems.Append(strEditorValue);
	}*/

}


