// COPYRIGHT Dassault Systemes 2011
//===================================================================
//
// PrtFstPointsCmd.cpp
// The state chart based command: PrtFstPointsCmd
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  Nov 2011  Creation: Code generated by the CAA wizard  Administrator
//===================================================================
#include "PrtFstPointsCmd.h"
#include "CATIndicationAgent.h"
#include "CATMathPlane.h"

#include "CATCreateExternalObject.h"
CATCreateClass( PrtFstPointsCmd);

#include "iostream"
using namespace std;

#include "CATLine.h"
#include "CATSurface.h"
#include "CATWire.h"
#include "CATIMfBiDimResult.h"
#include "CATIMfMonoDimResult.h"
#include "CATCurve.h"
#include "PrtService.h"
#include "CATIMfBRep.h"
#include "CATIGSMAssemble.h"
#include "CATIGSMCurvePar.h"
#include "CATIMeasurableCurve.h"
#include "CATIGSMExtremum.h"
#include "CATAcquisitionFilter.h"
#include "CATIGSMPointOnCurve.h"
#include "CATTopPointOperator.h"
//#include "CatTopPointLMode.h"
#include "CATComputePointOnWire.h"
#include "CAT3DPointRep.h"


//-------------------------------------------------------------------------
// Constructor
//-------------------------------------------------------------------------
PrtFstPointsCmd::PrtFstPointsCmd() :
  CATStateCommand ("PrtFstPointsCmd", CATDlgEngOneShot, CATCommandModeShared) 
//  Valid states are CATDlgEngOneShot and CATDlgEngRepeat
  ,m_pDlg(NULL),m_pRepeatPanelDlg(NULL),m_pCurveAgt(NULL),m_pSurfAgt(NULL),m_pCurveSLAgt(NULL),m_pSurfSLAgt(NULL),m_piPrdAgt(NULL),m_piPrdSLAgt(NULL)
  ,m_spAssembleSurfs(NULL_var),m_piDoc(NULL),m_spPointGSMTool(NULL_var),m_spCurvePar(NULL_var),m_piISO(NULL)
  ,m_dCurveOffsetValue(0),m_dPointsCount(0),m_dPointDistance(0),m_dType(1),m_spAssambleCurve(NULL_var),m_spRefPoint(NULL_var),m_spFirstPoint(NULL_var)
  ,m_dLengthspCurvePar(0),m_dLengthEndToStart(0),m_GSMOrientFirstPoint(CATGSMSameOrientation),m_ChangeFlag(FALSE)
{
	//初始化获得当前文档及名称
	m_piDoc = PrtService::GetPrtDocument();
	PrtService::GetPrdNumberFormDoc(m_piDoc,m_strDocName);

	//
	m_piEditor = CATFrmEditor::GetCurrentEditor();
	if (NULL != m_piEditor)
	{
		m_piHSO = m_piEditor->GetHSO();
		m_piHSO->Empty();

		m_piISO = m_piEditor->GetISO();
		m_piISO->Empty();
	}

	//判断是否为ZP模型;
	if ((!IsThisZPPrt(m_strDocName))||(!PrdService::IsContextualPrd()))
	{
		PrtService::ShowDlgNotify("提示","该功能仅在装配上下文环境且ZP模型中操作，点击关闭！");
		RequestDelayedDestruction();
	}
}

//判断是否为ZP模型
BOOL PrtFstPointsCmd::IsThisZPPrt(CATUnicodeString istrDocName)
{
	  if (istrDocName != "")
	  {
		  int istart=istrDocName.SearchSubString("-ZP",0,CATUnicodeString::CATSearchModeBackward);
		  if (istart != -1)
		  {
			  return TRUE;
		  }
		  else return FALSE;
	  }
	  else return FALSE;
}
//判断所选曲线是否CLOSED
BOOL PrtFstPointsCmd::IsClosedCircle(CATISpecObject_var ispCircle)
{
	if (ispCircle != NULL_var)
	{
		CATIGeometricalElement_var spGeoEle = ispCircle;
		CATBody_var spBody = spGeoEle->GetBodyResult();
		CATDomain * pDomain = spBody->GetDomain(1);
		//
		if (((CATWire *)pDomain)->IsClosed())
		{
			return TRUE;
		}
	}

	return FALSE;
}


//-------------------------------------------------------------------------
// Destructor
//-------------------------------------------------------------------------
PrtFstPointsCmd::~PrtFstPointsCmd()
{
	if (NULL!=m_pDlg)
	{
		m_pDlg->RequestDelayedDestruction();
		m_pDlg=NULL;
	}

	if (NULL!=m_pRepeatPanelDlg)
	{
		m_pRepeatPanelDlg->RequestDelayedDestruction();
		m_pRepeatPanelDlg=NULL;
	}
	
	if (NULL!=m_pCurveAgt)
	{
		m_pCurveAgt->RequestDelayedDestruction();
		m_pCurveAgt=NULL;
	}

	if (NULL!=m_pSurfAgt)
	{
		m_pSurfAgt->RequestDelayedDestruction();
		m_pSurfAgt=NULL;
	}

	if (NULL!=m_pCurveSLAgt)
	{
		m_pCurveSLAgt->RequestDelayedDestruction();
		m_pCurveSLAgt=NULL;
	}

	if (NULL!=m_pSurfSLAgt)
	{
		m_pSurfSLAgt->RequestDelayedDestruction();
		m_pSurfSLAgt=NULL;
	}

	if (NULL!=m_piPrdSLAgt)
	{
		m_piPrdSLAgt->RequestDelayedDestruction();
		m_piPrdSLAgt=NULL;
	}

	if (NULL!=m_piPrdAgt)
	{
		m_piPrdAgt->RequestDelayedDestruction();
		m_piPrdAgt=NULL;
	}

	//高亮点清空
	m_piHSO->Empty();
	m_piISO->Empty();
}


//-------------------------------------------------------------------------
// BuildGraph()
//-------------------------------------------------------------------------
void PrtFstPointsCmd::BuildGraph()
{
	//
	m_pDlg = new PrtFstPointsDlg();
	m_pDlg->Build();
	m_pDlg->SetVisibility(CATDlgShow); 
	
	//
	m_pRepeatPanelDlg = new PrtFstPointRepeatPanelDlg();
	m_pRepeatPanelDlg->Build();
	m_pRepeatPanelDlg->SetVisibility(CATDlgShow);

	// 主对话框的消息响应
	AddAnalyseNotificationCB (m_pDlg, 
		m_pDlg->GetDiaOKNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OkDlgCB,
		NULL);

	AddAnalyseNotificationCB (m_pDlg, 
		m_pDlg->GetWindCloseNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::CloseDlgCB,
		NULL);

	AddAnalyseNotificationCB (m_pDlg, 
		m_pDlg->GetDiaCANCELNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::CloseDlgCB,
		NULL);

	AddAnalyseNotificationCB (m_pDlg, 
		m_pDlg->GetDiaPREVIEWNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnPREVIEWCB,
		NULL);


	// 安装线偏移反向按钮响应
	AddAnalyseNotificationCB (m_pDlg->_ReverseDirePB, 
		m_pDlg->_ReverseDirePB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnReverseOffsetDirePBCB,
		NULL);
	// 参考极值点转换按钮响应
	AddAnalyseNotificationCB (m_pDlg->_ExtremityPB, 
		m_pDlg->_ExtremityPB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnRefPointExtremityPBCB,
		NULL);
	// 参考中心点转换按钮响应
	AddAnalyseNotificationCB (m_pDlg->_MiddlePB, 
		m_pDlg->_MiddlePB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnRefPointMiddlePBCB,
		NULL);
	// 参考点距离模式下反向按钮响应
	AddAnalyseNotificationCB (m_pDlg->_DisToRefInvertPushB, 
		m_pDlg->_DisToRefInvertPushB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnDisToRefInvertPBCB,
		NULL);
	//Ref End Point反向按钮响应
	AddAnalyseNotificationCB (m_pRepeatPanelDlg->_ExtremityPB, 
		m_pRepeatPanelDlg->_ExtremityPB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnRefEndPointExtremityPBCB,
		NULL);
	//预览按钮响应
	AddAnalyseNotificationCB (m_pRepeatPanelDlg->_PreviewPB, 
		m_pRepeatPanelDlg->_PreviewPB->GetPushBActivateNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnRepeatPanelPreviewPBCB,
		NULL);

	// 曲线偏移距离调整响应
	AddAnalyseNotificationCB (m_pDlg->_DistanceSpinner, 
		m_pDlg->_DistanceSpinner->GetSpinnerModifyNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnOffsetDistanceSpinnerCB,
		NULL);
	//Distance To Ref Point调整响应
	AddAnalyseNotificationCB (m_pDlg->_DisToRefSpinner, 
		m_pDlg->_DisToRefSpinner->GetSpinnerModifyNotification(),
		(CATCommandMethod)&PrtFstPointsCmd::OnDisToRefSpinnerCB,
		NULL);

	//
	//创建prd代理
	m_piPrdAgt = new CATPathElementAgent("选择连接零件");
	m_piPrdAgt -> SetBehavior( CATDlgEngWithPrevaluation | CATDlgEngWithPSOHSO | CATDlgEngRepeat  );
	m_piPrdAgt -> AddElementType (IID_CATIProduct);
	CATAcquisitionFilter * pFilterForPrt = Filter((FilterMethod) & PrtFstPointsCmd::SeletedIsPart,(void*)NULL);
	m_piPrdAgt->SetFilter(pFilterForPrt);

	//创建边线代理
	m_pCurveAgt = new CATFeatureImportAgent("选择边线");
	m_pCurveAgt -> SetBehavior( CATDlgEngWithPrevaluation | CATDlgEngWithPSO | CATDlgEngRepeat );
	m_pCurveAgt -> SetAgentBehavior( MfPermanentBody | MfLastFeatureSupport | MfRelimitedFeaturization);
	m_pCurveAgt -> AddElementType (IID_CATIMfMonoDimResult);
	m_pCurveAgt -> AddElementType (IID_CATCurve);

	//创建安装面代理
	m_pSurfAgt = new CATFeatureImportAgent("选择安装面");
	m_pSurfAgt -> SetBehavior( CATDlgEngWithPrevaluation | CATDlgEngWithPSO | CATDlgEngRepeat );
	m_pSurfAgt -> SetAgentBehavior( MfPermanentBody | MfLastFeatureSupport | MfRelimitedFeaturization);
	m_pSurfAgt -> AddElementType (IID_CATIMfBiDimResult);
	m_pSurfAgt -> AddElementType (IID_CATSurface);

	//Surf SL
	m_piPrdSLAgt = new CATDialogAgent("选择连接零件SL");
	m_piPrdSLAgt->SetBehavior(CATDlgEngRepeat);
	m_piPrdSLAgt->AcceptOnNotify(m_pDlg->_ContextSelectorList,m_pDlg->_ContextSelectorList->GetListSelectNotification());

	//Curve SL
	m_pCurveSLAgt = new CATDialogAgent("选择边线SL");
	m_pCurveSLAgt->SetBehavior(CATDlgEngRepeat);
	m_pCurveSLAgt->AcceptOnNotify(m_pDlg->_CurveSL,m_pDlg->_CurveSL->GetListSelectNotification());

	//Surf SL
	m_pSurfSLAgt = new CATDialogAgent("选择安装面SL");
	m_pSurfSLAgt->SetBehavior(CATDlgEngRepeat);
	m_pSurfSLAgt->AcceptOnNotify(m_pDlg->_SurfSL,m_pDlg->_SurfSL->GetListSelectNotification());


	//Define the StateChart
	CATDialogState * StSelectPrds = GetInitialState("选择连接零件");
	StSelectPrds -> AddDialogAgent (m_piPrdAgt);
	StSelectPrds -> AddDialogAgent (m_piPrdSLAgt);
	StSelectPrds -> AddDialogAgent (m_pCurveSLAgt);
	StSelectPrds -> AddDialogAgent (m_pSurfSLAgt);	

	CATDialogState * StSelectCurve = AddDialogState("选择边线");
	StSelectCurve -> AddDialogAgent (m_pCurveAgt);
	StSelectCurve -> AddDialogAgent (m_pCurveSLAgt);
	StSelectCurve -> AddDialogAgent (m_pSurfSLAgt);
	StSelectCurve -> AddDialogAgent (m_piPrdSLAgt);

	CATDialogState * StSelectSurf = AddDialogState("选择安装面");
	StSelectSurf -> AddDialogAgent (m_pSurfAgt);
	StSelectSurf -> AddDialogAgent (m_pCurveSLAgt);
	StSelectSurf -> AddDialogAgent (m_pSurfSLAgt);
	StSelectSurf -> AddDialogAgent (m_piPrdSLAgt);

	//转换关系 Prd Prd
	AddTransition(StSelectPrds,StSelectPrds,
		IsLastModifiedAgentCondition(m_piPrdAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ChoosePrds));
	//转换关系 Prd PrdSL
	AddTransition(StSelectPrds,StSelectPrds,
		IsLastModifiedAgentCondition(m_piPrdSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActivePrdSL));
	//转换关系 Prd 线SL
	AddTransition(StSelectPrds,StSelectCurve,
		IsLastModifiedAgentCondition(m_pCurveSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveCurveSL));
	//转换关系 Prd 面SL
	AddTransition(StSelectPrds,StSelectSurf,
		IsLastModifiedAgentCondition(m_pSurfSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveSurfSL));

	//转换关系 线到线
	AddTransition(StSelectCurve, StSelectCurve, 
		IsLastModifiedAgentCondition(m_pCurveAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ChooseCurve));
	//转换关系 线到线SL
	AddTransition(StSelectCurve, StSelectCurve, 
		IsLastModifiedAgentCondition(m_pCurveSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveCurveSL));
	//转换关系 线到PrdSL
	AddTransition(StSelectCurve, StSelectPrds, 
		IsLastModifiedAgentCondition(m_piPrdSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActivePrdSL));
	//转换关系 线到面SL
	AddTransition(StSelectCurve, StSelectSurf, 
		IsLastModifiedAgentCondition(m_pSurfSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveSurfSL));


	//转换关系 面到面
	AddTransition(StSelectSurf, StSelectSurf, 
		IsLastModifiedAgentCondition(m_pSurfAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ChooseSurf));
	//转换关系 面到面SL
	AddTransition(StSelectSurf, StSelectSurf, 
		IsLastModifiedAgentCondition(m_pSurfSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveSurfSL));
	//转换关系 面到线SL
	AddTransition(StSelectSurf, StSelectCurve, 
		IsLastModifiedAgentCondition(m_pCurveSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActiveCurveSL));
	//转换关系 面到PrdSL
	AddTransition(StSelectSurf, StSelectPrds, 
		IsLastModifiedAgentCondition(m_piPrdSLAgt),
		Action ((ActionMethod) &PrtFstPointsCmd::ActivePrdSL));
	
	
}

CATBoolean PrtFstPointsCmd::SeletedIsPart(CATDialogAgent * iAgent, void * iUsefulData)
{
	CATBoolean rc = FALSE ;
	if ( NULL == iAgent ) return rc ;

	CATBaseUnknown* piSelectElement =m_piPrdAgt->GetElementValue();//获得所选对象
	if (piSelectElement != NULL)
	{
		CATIProduct_var spPrd = NULL_var;
		spPrd = piSelectElement;

		CATUnicodeString strDocType("");
		PrdService::GetInstPrdType(spPrd,strDocType);

		if (strDocType == "CATPart")
		{
			return TRUE;
		}
	}

	return rc;
}


CATBoolean PrtFstPointsCmd::ActivePrdSL( void *UsefulData)
{
	m_pDlg->_SurfSL->ClearSelect();
	m_pDlg->_CurveSL->ClearSelect();

	//清除高亮
	PrtService::ClearHSO();
	//加入需要高亮的特征
	ShowSeletedLine(m_pDlg->_ContextSelectorList,m_lstSpecPrds);
	//
	if (NULL_var != m_spAssembleSurfs)
	{
		PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
	}
	//
	//隐藏安装面
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Hide");
	}
	//
	m_piPrdAgt->InitializeAcquisition();
	return TRUE;
}

//高亮显示当前所选行
void PrtFstPointsCmd::ShowSeletedLine(CATDlgSelectorList* opiSL,CATListValCATISpecObject_var olstSpecs)
{
	//如果为空，直接退出
	if (olstSpecs.Size() == 0)
	{
		return;
	}
	//获取所选行
	int NumberOfRowsSelected;
	NumberOfRowsSelected = opiSL->GetSelectCount();

	int *iSelectedRows = new int[NumberOfRowsSelected];
	opiSL->GetSelect(iSelectedRows,NumberOfRowsSelected);

	//重新添加高亮
	for (int i = 0; i < NumberOfRowsSelected; i ++)
	{
		PrtService::HighlightHSO(olstSpecs[iSelectedRows[i]+1]);
	}
}

//转变OK APPLY按钮的显示状态
void PrtFstPointsCmd::ChangeOKApplyState()
{
	//控制APPLY&OK状态
	if (m_lstSpecCurves.Size()!=0 && m_lstSpecPrds.Size()!=0 && m_lstSpecSurfs.Size()!=0)
	{
		m_pDlg->SetOKSensitivity(CATDlgEnable);
		m_pDlg->SetPREVIEWSensitivity(CATDlgEnable);

		if (m_spFirstPoint != NULL_var)
		{
			//
			m_pDlg->_ExtremityPB->SetSensitivity(CATDlgEnable);
			m_pDlg->_MiddlePB->SetSensitivity(CATDlgEnable);
			m_pDlg->_ReverseDirePB->SetSensitivity(CATDlgEnable);
			m_pDlg->_DisToRefInvertPushB->SetSensitivity(CATDlgEnable);	
			m_pRepeatPanelDlg->_ExtremityPB->SetSensitivity(CATDlgEnable);
		}

		//
		if (m_spFirstPoint != NULL_var && m_ChangeFlag == FALSE)
		{
			m_pRepeatPanelDlg->_PreviewPB->SetSensitivity(CATDlgEnable);
		}
		else
		{
			m_pRepeatPanelDlg->_PreviewPB->SetSensitivity(CATDlgDisable);
		}
	}
	else
	{
		m_pDlg->SetOKSensitivity(CATDlgDisable);
		m_pDlg->SetPREVIEWSensitivity(CATDlgDisable);	
		m_pRepeatPanelDlg->_PreviewPB->SetSensitivity(CATDlgDisable);
		//
		//
		m_pDlg->_ExtremityPB->SetSensitivity(CATDlgDisable);
		m_pDlg->_MiddlePB->SetSensitivity(CATDlgDisable);
		m_pDlg->_ReverseDirePB->SetSensitivity(CATDlgDisable);
		m_pDlg->_DisToRefInvertPushB->SetSensitivity(CATDlgDisable);
		m_pRepeatPanelDlg->_ExtremityPB->SetSensitivity(CATDlgDisable);
		//
		//删除第一点的信息
		if (m_spAssambleCurve != NULL_var && m_spRefPoint != NULL_var && m_spFirstPoint != NULL_var && m_spPointGSMTool != NULL_var && m_spCurvePar != NULL_var)
		{
			//删除已有信息
			m_spPointGSMTool->GetFather()->Remove(m_spPointGSMTool);
			//重置为NULL_var
			m_spAssambleCurve = NULL_var;
			m_spAssembleSurfs = NULL_var;
			m_spRefPoint=NULL_var;
			m_spFirstPoint=NULL_var;
			m_spPointGSMTool=NULL_var;
			m_spCurvePar=NULL_var;	
			//								
		}
		//
		m_piISO->Empty();
	}
}

//消息框响应函数
void PrtFstPointsCmd::OkDlgCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//
	m_piISO->Empty();
	m_piHSO->Empty();
	//计算当前长度，方向等参考信息
	CalculateStartEndPointInfo();

	// 获取Repeat Panel界面的参数信息
	if (m_pRepeatPanelDlg->m_IChoosedIndex == 0)
	{
		//
		double dStepValue = 0;
		//安装点个数模式
		double dCount = m_pRepeatPanelDlg->_InstancesSpinner->GetValue();
		//
		if (m_pRepeatPanelDlg->_CheckB->GetState() == CATDlgCheck && dCount != 1)
		{
			//
			dStepValue = m_dLengthEndToStart / (dCount-1);						
		} 
		else
		{
			//
			dStepValue = m_dLengthEndToStart / dCount;
		}
		//
		//创建安装点位置信息
		//
		for (int i = 1; i < dCount; i++)
		{
			//
			//
			double dFirstValue = m_pDlg->_DisToRefSpinner->GetValue()*1000.0;
			double dNextValue = dFirstValue + dStepValue*i;
			//
			if (dNextValue < 0)
			{
				if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
				{
					CreateResultPoints(-dNextValue,CATGSMInvertOrientation);
				} 
				else
				{
					CreateResultPoints(dNextValue,CATGSMSameOrientation);
				}
				
			}
			else
			{
				CreateResultPoints(dNextValue,m_GSMOrientFirstPoint);
			}
		}

	} 
	else if (m_pRepeatPanelDlg->m_IChoosedIndex == 1)
	{
		//安装点间距模式
		//个数&间距模式
		double dStepValue = m_pRepeatPanelDlg->_PitchSpinner->GetValue()*1000;
		//安装点个数模式
		double dCount = (int)(m_dLengthEndToStart/dStepValue)+1;
		//
		if (m_pRepeatPanelDlg->_CheckB->GetState() == CATDlgUncheck && dCount != 1)
		{
			//
			dCount -= 1;						
		} 
		//
		if (m_pRepeatPanelDlg->_BestFitCheckB->GetState() == CATDlgCheck)
		{
			int iCount =  (int)(m_dLengthEndToStart/dStepValue);
			if (iCount != 0)
			{
				dStepValue = m_dLengthEndToStart/iCount;
				//
				CATUnicodeString str; str.BuildFromNum(dStepValue);
				str += "mm";
				m_pRepeatPanelDlg->_BestFitEditor->SetText(str);
			}			
		}

		//
		//创建安装点位置信息
		//
		for (int i = 1; i < dCount; i++)
		{
			//
			//
			double dFirstValue = m_pDlg->_DisToRefSpinner->GetValue()*1000.0;
			double dNextValue = dFirstValue + dStepValue*i;
			//
			if (dNextValue < 0)
			{
				if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
				{
					CreateResultPoints(-dNextValue,CATGSMInvertOrientation);
				} 
				else
				{
					CreateResultPoints(dNextValue,CATGSMSameOrientation);
				}

			}
			else
			{
				CreateResultPoints(dNextValue,m_GSMOrientFirstPoint);
			}
		}
	} 
	else if (m_pRepeatPanelDlg->m_IChoosedIndex == 2)
	{
		//个数&间距模式
		double dStepValue = m_pRepeatPanelDlg->_PitchSpinner->GetValue()*1000;
		//安装点个数模式
		double dCount = m_pRepeatPanelDlg->_InstancesSpinner->GetValue();
		//
		//创建安装点位置信息
		//
		for (int i = 1; i < dCount; i++)
		{
			//
			//
			double dFirstValue = m_pDlg->_DisToRefSpinner->GetValue()*1000.0;
			double dNextValue = dFirstValue + dStepValue*i;
			//
			if (dNextValue < 0)
			{
				if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
				{
					CreateResultPoints(-dNextValue,CATGSMInvertOrientation);
				} 
				else
				{
					CreateResultPoints(dNextValue,CATGSMSameOrientation);
				}

			}
			else
			{
				CreateResultPoints(dNextValue,m_GSMOrientFirstPoint);
			}
		}

	}	
	//
	CATIPrtContainer *opiRootContainer = NULL;
	PrtService::ObtainRootContainer(m_piDoc,opiRootContainer);
	//获得part
	CATISpecObject_var spPart = opiRootContainer->GetPart();
	PrtService::ObjectUpdate(spPart);

	//隐藏线
	for (int i = 1; i <= m_lstSpecCurves.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecCurves[i],"Hide");
	}

	//隐藏面
	PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
	//隐藏安装面
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Hide");
	}

	//
	RequestDelayedDestruction();
}
void PrtFstPointsCmd::CloseDlgCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//隐藏线
	for (int i = 1; i <= m_lstSpecCurves.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecCurves[i],"Hide");
	}

	//隐藏面
	PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
	//隐藏安装面
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Hide");
	}

	//删除几何图形集
	if (m_spPointGSMTool!=NULL_var)
	{
		m_spPointGSMTool->GetFather()->Remove(m_spPointGSMTool);
	}

	RequestDelayedDestruction();
}

//
//响应
CATBoolean PrtFstPointsCmd::ChoosePrds( void *UsefulData)
{
	HRESULT hr = E_FAIL;

	CATPathElement* piSelectElement =m_piPrdAgt->GetValue();//获得所选对象
	if (piSelectElement != NULL)
	{
		//获得SUB PATH
		CATBaseUnknown * pLeaf =NULL ;
		//获得路径下第一个特征spec类型
		pLeaf = (*piSelectElement)[piSelectElement->GetSize()-1];
		CATISpecObject_var spSpecOnSelection = NULL_var;
		spSpecOnSelection = pLeaf;

		if ( spSpecOnSelection != NULL_var )
		{
			CATBoolean existFlag = FALSE;
			for (int i = 1; i <= m_lstSpecPrds.Size(); i ++)
			{
				if (m_lstSpecPrds[i] == spSpecOnSelection)
				{
					m_lstSpecPrds.RemoveValue(spSpecOnSelection);
					existFlag = TRUE;
					break;
				}
			}

			if (existFlag == FALSE)
			{
				CATDocument* opiPrdDoc = NULL;
				PrdService::GetInstPrdDoc(spSpecOnSelection,opiPrdDoc);
				CATUnicodeString strPrdName;
				PrtService::GetPrdNumberFormDoc(opiPrdDoc,strPrdName);

				if (IsThisZPPrt(strPrdName))
				{
					PrtService::ktWarningMsgBox("不能选择ZP模型为安装零件，请重新选择！");
					PrtService::RemoveHSO(spSpecOnSelection);
				}
				else
					m_lstSpecPrds.Append(spSpecOnSelection);				
			}

			m_pDlg->_ContextSelectorList->ClearLine();
			for (int i = 1; i <= m_lstSpecPrds.Size(); i ++)
			{
				//
				CATUnicodeString strShowPath("");
				CATPathElement *piPath = NULL;
				PrtService::GetPathElementFromSpecObject(piPath,m_lstSpecPrds[i],NULL);
				PrtService::PathElementString(piPath,strShowPath,TRUE);
				m_pDlg->_ContextSelectorList->SetLine(strShowPath);

				piPath->Release();
				piPath=NULL;
			}

			if (m_lstSpecPrds.Size()==0)
			{
				m_pDlg->_ContextSelectorList->SetLine("请选择连接零件");
			}
		}
	}

	//
	m_pDlg->_SurfSL->ClearSelect();
	m_pDlg->_CurveSL->ClearSelect();

	//
	PrtService::ClearHSO();
	PrtService::HighLightObjLst(m_lstSpecPrds);

	//
	ChangeOKApplyState();
	m_piPrdAgt->InitializeAcquisition();
	return TRUE;	
}

//
CATBoolean PrtFstPointsCmd::ChooseCurve( void *UsefulData)
{
	HRESULT hr = E_FAIL;

	CATBaseUnknown* piSelectElement =m_pCurveAgt->GetElementValue();//获得所选对象
	if (piSelectElement != NULL)
	{
		//获得SUB PATH
		CATIMfBRep *piBrep = NULL;
		hr = piSelectElement->QueryInterface(IID_CATIMfBRep,(void**)&piBrep);
		//
		CATISpecObject_var spSpecOnSelection =NULL_var;
		if (SUCCEEDED(hr)&&(piBrep!=NULL))
		{
			spSpecOnSelection = piBrep->GetSupport();
			piBrep->Release();
			piBrep=NULL;
		}
		else
		{
			spSpecOnSelection = piSelectElement;
		}

		//根据情况判断
		if ( spSpecOnSelection != NULL_var )
		{
			CATBoolean existFlag = FALSE;
			for (int i = 1; i <= m_lstSpecCurves.Size(); i ++)
			{
				if (m_lstSpecCurves[i] == spSpecOnSelection)
				{
					m_lstSpecCurves.RemoveValue(spSpecOnSelection);
					PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Hide");
					PrtService::RemoveHSO(spSpecOnSelection);
					existFlag = TRUE;
					break;
				}
			}

			if (existFlag == FALSE)
			{		
				PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Show");
				m_lstSpecCurves.Append(spSpecOnSelection);
				PrtService::HighlightHSO(spSpecOnSelection);				
			}

			if (m_lstSpecCurves.Size()>=1)
			{
				CATUnicodeString strLineShow("共选择");
				CATUnicodeString strNumber;
				strNumber.BuildFromNum(m_lstSpecCurves.Size());
				strLineShow += strNumber + "个线";
				m_pDlg->_CurveSL->SetLine(strLineShow,0,CATDlgDataModify);
			}
			if (m_lstSpecCurves.Size()==0)
			{
				m_pDlg->_CurveSL->SetLine("No Selection",0,CATDlgDataModify);
			}
		}

		//
		m_ChangeFlag = TRUE;
	}

	//
	m_pDlg->_SurfSL->ClearSelect();
	//
	ChangeOKApplyState();
	m_pCurveAgt->InitializeAcquisition();
	return TRUE;
}
CATBoolean PrtFstPointsCmd::ChooseSurf( void *UsefulData)
{
	HRESULT hr = E_FAIL;

	CATBaseUnknown* piSelectElement =m_pSurfAgt->GetElementValue();//获得所选对象
	if (piSelectElement != NULL)
	{
		//获得SUB PATH
		CATIMfBRep *piBrep = NULL;
		hr = piSelectElement->QueryInterface(IID_CATIMfBRep,(void**)&piBrep);
		//
		CATISpecObject_var spSpecOnSelection =NULL_var;
		if (SUCCEEDED(hr)&&(piBrep!=NULL))
		{
			spSpecOnSelection = piBrep->GetSupport();
			piBrep->Release();
			piBrep=NULL;
		}
		else
		{
			spSpecOnSelection = piSelectElement;
		}

		//根据情况判断
		if ( spSpecOnSelection != NULL_var )
		{
			CATBoolean existFlag = FALSE;
			for (int i = 1; i <= m_lstSpecSurfs.Size(); i ++)
			{
				if (m_lstSpecSurfs[i] == spSpecOnSelection)
				{
					m_lstSpecSurfs.RemoveValue(spSpecOnSelection);
					PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Hide");
					PrtService::RemoveHSO(spSpecOnSelection);
					existFlag = TRUE;
					break;
				}
			}

			if (existFlag == FALSE)
			{
				//判断确定所引用的曲面所在零件必须在定义上下文中
				CATIProduct_var spRefPrd;
				GetLinkImportPrd(spSpecOnSelection,spRefPrd);
				if (m_lstSpecPrds.Size() >= 2)
				{
					if (IsTheSpecInLstSpec(spRefPrd,m_lstSpecPrds))
					{
						PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Show");
						m_lstSpecSurfs.Append(spSpecOnSelection);
						PrtService::HighlightHSO(spSpecOnSelection);
					}
					else
					{
						PrtService::ktErrorMsgBox("当前所选元素所在零件不在“设计上下文”列表中，请重新选择！");
					}
				}
				else //当前“设计上下文”元素小于二个
				{
					PrtService::ktWarningMsgBox("“设计上下文”零件列表必须大于等于2，请首先选择设计上下文零件！");
				}		
			}

			if (m_lstSpecSurfs.Size()>=1)
			{
				CATUnicodeString strLineShow("共选择");
				CATUnicodeString strNumber;
				strNumber.BuildFromNum(m_lstSpecSurfs.Size());
				strLineShow += strNumber + "个面";
				m_pDlg->_SurfSL->SetLine(strLineShow,0,CATDlgDataModify);
			}
			if (m_lstSpecSurfs.Size()==0)
			{
				m_pDlg->_SurfSL->SetLine("No Selection",0,CATDlgDataModify);
			}
		}

		//
		m_ChangeFlag = TRUE;
	}

	//
	m_pDlg->_CurveSL->ClearSelect();

	//
	ChangeOKApplyState();
	m_pSurfAgt->InitializeAcquisition();
	return TRUE;
}

//CATBoolean PrtFstPointsCmd::ChooseSurf( void *UsefulData)
//{
//	HRESULT hr = E_FAIL;
//
//	CATBaseUnknown* piSelectElement =m_pSurfAgt->GetElementValue();//获得所选对象
//	if (piSelectElement != NULL)
//	{
//		//获得SUB PATH
//		CATIMfBRep *piBrep = NULL;
//		hr = piSelectElement->QueryInterface(IID_CATIMfBRep,(void**)&piBrep);
//		//
//		CATISpecObject_var spSpecOnSelection =NULL_var;
//		if (SUCCEEDED(hr)&&(piBrep!=NULL))
//		{
//			spSpecOnSelection = piBrep->GetSupport();
//			piBrep->Release();
//			piBrep=NULL;
//		}
//		else
//		{
//			spSpecOnSelection = piSelectElement;
//		}
//
//		//根据情况判断
//		if ( spSpecOnSelection != NULL_var )
//		{
//			if (m_SpecSurfs == spSpecOnSelection)
//			{
//				PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Hide");
//				PrtService::RemoveHSO(spSpecOnSelection);
//				m_pDlg->_SurfSL->SetLine("No Selection",0,CATDlgDataModify);
//				m_SpecSurfs = NULL_var;
//			}	
//			else
//			{	
//				PrtService::SetSpecObjShowAttr(m_SpecSurfs,"Hide");
//				PrtService::RemoveHSO(m_SpecSurfs);
//				PrtService::SetSpecObjShowAttr(spSpecOnSelection,"Show");
//				PrtService::HighlightHSO(spSpecOnSelection);
//				m_SpecSurfs = spSpecOnSelection;
//				//
//				CATUnicodeString strShowPath("");
//				CATPathElement *piPath = NULL;
//				PrtService::GetPathElementFromSpecObject(piPath,spSpecOnSelection,NULL);
//				PrtService::PathElementString(piPath,strShowPath,TRUE);
//				m_pDlg->_SurfSL->SetLine(strShowPath,0,CATDlgDataModify);
//
//				piPath->Release();
//				piPath=NULL;
//			}
//		}
//
//		//
//		m_ChangeFlag = TRUE;
//	}
//
//	//
//	m_pDlg->_CurveSL->ClearSelect();
//
//	//
//	ChangeOKApplyState();
//	m_pSurfAgt->InitializeAcquisition();
//	return TRUE;
//}
//
CATBoolean PrtFstPointsCmd::ActiveCurveSL( void *UsefulData)
{
	//高亮所选线
	PrtService::ClearHSO();
	PrtService::HighLightObjLst(m_lstSpecCurves);

	//
	m_pDlg->_SurfSL->ClearSelect();
	m_pDlg->_ContextSelectorList->ClearSelect();
	//
	if (NULL_var != m_spAssembleSurfs)
	{
		PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
	}
	//
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Hide");
	}
	//
	m_pCurveAgt->InitializeAcquisition();
	return TRUE;
}
CATBoolean PrtFstPointsCmd::ActiveSurfSL( void *UsefulData)
{
	//高亮所选面
	PrtService::ClearHSO();
	PrtService::HighLightObjLst(m_lstSpecSurfs);

	//
	m_pDlg->_CurveSL->ClearSelect();
	m_pDlg->_ContextSelectorList->ClearSelect();
	//
	//安装面
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Show");
	}
	//
	m_pSurfAgt->InitializeAcquisition();
	return TRUE;
}

void PrtFstPointsCmd::OnPREVIEWCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//
	//删除第一点的信息
	if (m_spAssambleCurve != NULL_var && m_spRefPoint != NULL_var && m_spFirstPoint != NULL_var && m_spPointGSMTool != NULL_var && m_spCurvePar != NULL_var)
	{
		//删除已有信息
		m_spPointGSMTool->GetFather()->Remove(m_spPointGSMTool);
		//重置为NULL_var
		m_spAssambleCurve = NULL_var;
		m_spRefPoint=NULL_var;
		m_spFirstPoint=NULL_var;
		m_spPointGSMTool=NULL_var;
		m_spCurvePar=NULL_var;	
		m_spAssembleSurfs=NULL_var;
		//								
	}
	//创建第一点
	CreateFastenerFirstPoint();

	//
	if (m_spAssambleCurve != NULL_var && m_spRefPoint != NULL_var && m_spFirstPoint != NULL_var && m_spPointGSMTool != NULL_var && m_spCurvePar != NULL_var && m_spAssembleSurfs != NULL_var)
	{
		//显示方向标识
		//
		if (IsClosedCircle(m_spAssambleCurve))
		{
			m_pDlg->_RefPointEditor->SetText("Extremum");
			//
			m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
			m_pRepeatPanelDlg->_ExtremityPB->SetSensitivity(CATDlgDisable);
		}
		else
		{
			m_pDlg->_RefPointEditor->SetText("Start Extremity");
			m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
			m_pRepeatPanelDlg->_ExtremityPB->SetSensitivity(CATDlgEnable);
		}

		//设置SPINNER范围
		GetCurveLength();
		//设置参数
		double Start, End, StepMM;
		Start = 0.0;
		End = m_dLengthspCurvePar*0.001;
		StepMM = 0.001;
		//
		m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End, StepMM);
		m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		//
		//
		m_ChangeFlag = FALSE;
		ChangeOKApplyState();
	}
	//
	//隐藏面
	PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
	//隐藏安装面
	for (int i = 1; i <= m_lstSpecSurfs.Size(); i++)
	{
		PrtService::SetSpecObjShowAttr(m_lstSpecSurfs[i],"Hide");
	}
	//
	m_piISO->Empty();
	//
	m_piISO->AddElement(m_spCurvePar);
}

//安装线偏移反向按钮响应
void PrtFstPointsCmd::OnReverseOffsetDirePBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//
	if (m_spCurvePar!=NULL_var)
	{
		CATBoolean bDireState;
		CATIGSMCurvePar_var spGSMPar = m_spCurvePar;
		spGSMPar->GetInvertDirection(bDireState);
		//
		if (bDireState == FALSE)
		{
			//
			spGSMPar->SetInvertDirection(TRUE);
			//
			HRESULT rc = PrtService::ObjectUpdate(m_spCurvePar);
			if (FAILED(rc))
			{
				PrtService::ShowDlgNotify("错误提示","反向更新错误，将保持原方向");
				//
				spGSMPar->SetInvertDirection(FALSE);				
			}
		} 
		else
		{
			//
			spGSMPar->SetInvertDirection(FALSE);
			//
			HRESULT rc = PrtService::ObjectUpdate(m_spCurvePar);
			if (FAILED(rc))
			{
				PrtService::ShowDlgNotify("错误提示","反向更新错误，将保持原方向");
				//
				spGSMPar->SetInvertDirection(TRUE);				
			}
		}

		//
		PrtService::ObjectUpdate(m_spPointGSMTool);

		//
		//设置SPINNER范围
		GetCurveLength();
		//
		if (m_pDlg->_RefPointEditor->GetText() == "Middle")
		{
			//设置参数
			double Start, End, StepMM;
			Start = 0.0;
			End = m_dLengthspCurvePar*0.001;
			StepMM = 0.001;
			//
			m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End*0.5, StepMM);
			m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		} 
		else 
		{
			//设置参数
			double Start, End, StepMM;
			Start = 0.0;
			End = m_dLengthspCurvePar*0.001;
			StepMM = 0.001;
			//
			m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End, StepMM);
			m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		}	
	}
	//
}

//参考极值点转换按钮响应
void PrtFstPointsCmd::OnRefPointExtremityPBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	if (m_spFirstPoint!=NULL_var)
	{
		if (m_pDlg->_RefPointEditor->GetText() == "Start Extremity")
		{
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve01 = m_spRefPoint;
			spGSMPointOnCurve01->InvertOrientation ();
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve02 = m_spFirstPoint;
			spGSMPointOnCurve02->InvertOrientation ();

			HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
			rc = PrtService::ObjectUpdate(m_spFirstPoint);
			if (FAILED(rc))
			{
				PrtService::ShowDlgNotify("错误提示","反向后更新错误，将保持原方向!");
				spGSMPointOnCurve01->InvertOrientation ();
				spGSMPointOnCurve02->InvertOrientation ();
				PrtService::ObjectUpdate(m_spFirstPoint);
				m_pDlg->_RefPointEditor->SetText("Start Extremity");
				m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
			}
			else
			{
				m_pDlg->_RefPointEditor->SetText("End Extremity");
				m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("Start Extremity");
			}

		} 
		else if (m_pDlg->_RefPointEditor->GetText() == "End Extremity")
		{
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve01 = m_spRefPoint;
			spGSMPointOnCurve01->InvertOrientation ();
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve02 = m_spFirstPoint;
			spGSMPointOnCurve02->InvertOrientation ();

			HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
			rc = PrtService::ObjectUpdate(m_spFirstPoint);
			if (FAILED(rc))
			{
				PrtService::ShowDlgNotify("错误提示","反向后更新错误，将保持原方向!");
				spGSMPointOnCurve01->InvertOrientation ();
				spGSMPointOnCurve02->InvertOrientation ();
				PrtService::ObjectUpdate(m_spFirstPoint);
				m_pDlg->_RefPointEditor->SetText("End Extremity");
				m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("Start Extremity");
			}
			else
			{
				m_pDlg->_RefPointEditor->SetText("Start Extremity");
				m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
			}
		}

		else if (m_pDlg->_RefPointEditor->GetText() == "Middle")
		{
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve01 = m_spRefPoint;
			spGSMPointOnCurve01->SetOrientation(CATGSMSameOrientation);
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve02 = m_spFirstPoint;
			spGSMPointOnCurve02->SetOrientation(CATGSMSameOrientation);
			//
			//创建极值点，采用Ratio模式
			double dRatioValue = 0.0;
			CATICkeParm_var spCkedRatioValue = NULL_var;
			spCkedRatioValue = PrtService::LocalInstLitteral(&dRatioValue,1,"Real","Ratio");
			//
			CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spRefPoint;
			spGSMPointOnCurve->SetLength(spCkedRatioValue);
			//
			HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
			//
			m_pDlg->_RefPointEditor->SetText("Start Extremity");
			m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
			//
			//设置SPINNER范围
			GetCurveLength();
			//设置参数
			double Start, End, StepMM;
			Start = 0.0;
			End = m_dLengthspCurvePar*0.001;
			StepMM = 0.001;
			//
			m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End, StepMM);
			m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		}
	}
}
//参考中心点转换按钮响应
void PrtFstPointsCmd::OnRefPointMiddlePBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	if (m_spFirstPoint != NULL_var && m_pDlg->_RefPointEditor->GetText() != "Extremum")
	{
		//创建极值点，采用Ratio模式
		double dRatioValue = 0.5;
		CATICkeParm_var spCkedRatioValue = NULL_var;
		spCkedRatioValue = PrtService::LocalInstLitteral(&dRatioValue,1,"Real","Ratio");
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spRefPoint;
		spGSMPointOnCurve->SetLength(spCkedRatioValue);
		//
		spGSMPointOnCurve->InvertOrientation();
		//
		HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
		if (FAILED(rc))
		{
			PrtService::ShowDlgNotify("错误提示","当前设置参数无法基于中间点模式!");
			return;	
		}
		//
		m_pDlg->_RefPointEditor->SetText("Middle");
		//
		//设置SPINNER范围
		GetCurveLength();
		//设置参数
		double Start, End, StepMM;
		Start = 0.0;
		End = m_dLengthspCurvePar*0.001;
		StepMM = 0.001;
		//
		m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End*0.5, StepMM);
		m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
	}
}
//参考点距离模式下反向按钮响应
void PrtFstPointsCmd::OnDisToRefInvertPBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//
	if (m_spFirstPoint!=NULL_var && m_pDlg->_RefPointEditor->GetText() == "Middle")
	{
		CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spFirstPoint;
		spGSMPointOnCurve->InvertOrientation ();
		//
		HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		if (FAILED(rc))
		{
			PrtService::ShowDlgNotify("错误提示","反向后更新错误，将保持原方向!");
			spGSMPointOnCurve->InvertOrientation ();
			PrtService::ObjectUpdate(m_spFirstPoint);
		}
		//		
	}
}
//Ref End Point反向按钮响应
void PrtFstPointsCmd::OnRefEndPointExtremityPBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	if (m_spFirstPoint != NULL_var && m_pDlg->_RefPointEditor->GetText() != "Extremum")
	{
		if (m_pRepeatPanelDlg->_RefEndPointExtremityEditor->GetText() == "Start Extremity")
		{
			m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
		} 
		else
		{
			m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("Start Extremity");
		}
	}

	if (m_spFirstPoint != NULL_var && m_pDlg->_RefPointEditor->GetText() == "Extremum")
	{
		m_pRepeatPanelDlg->_RefEndPointExtremityEditor->SetText("End Extremity");
	}
}

//曲线偏移距离调整响应
void PrtFstPointsCmd::OnOffsetDistanceSpinnerCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	if (m_spCurvePar != NULL_var)
	{
		//创建平行线
		double dOffsetValue = m_pDlg->_DistanceSpinner->GetValue();
		dOffsetValue *= 1000.0;
		m_dCurveOffsetValue = dOffsetValue;
		//
		CATICkeParm_var spCkeOffset = NULL_var;
		spCkeOffset = PrtService::LocalInstLitteral(&dOffsetValue,1,"Length","Length");
		//
		CATIGSMCurvePar_var spGSMCurvePar=m_spCurvePar;
		spGSMCurvePar->SetCurveParValue(spCkeOffset);
		//
		HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
		if (FAILED(rc))
		{
			spGSMCurvePar->SetInvertDirection(TRUE);
		}
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		if (FAILED(rc))
		{
			PrtService::ShowDlgNotify("错误提示","所选线在所选安装面上无法生成平行线!");
			return;	
		}

		//
		//设置SPINNER范围
		GetCurveLength();
		//
		if (m_pDlg->_RefPointEditor->GetText() == "Middle")
		{
			//设置参数
			double Start, End, StepMM;
			Start = 0.0;
			End = m_dLengthspCurvePar*0.001;
			StepMM = 0.001;
			//
			m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End*0.5, StepMM);
			m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		} 
		else 
		{
			//设置参数
			double Start, End, StepMM;
			Start = 0.0;
			End = m_dLengthspCurvePar*0.001;
			StepMM = 0.001;
			//
			m_pDlg->_DisToRefSpinner->SetMinMaxStep(Start, End, StepMM);
			m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->SetMinMaxStep(Start, End, StepMM);
		}	
		
	}	
}

//Distance To Ref Point调整响应
void PrtFstPointsCmd::OnDisToRefSpinnerCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	if (m_spFirstPoint != NULL_var)
	{
		//创建平行线
		double dOffsetValue = m_pDlg->_DisToRefSpinner->GetValue();
		dOffsetValue *= 1000.0;
		//
		CATICkeParm_var spCkeOffset = NULL_var;
		spCkeOffset = PrtService::LocalInstLitteral(&dOffsetValue,1,"Length","Length");
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spFirstPoint;
		spGSMPointOnCurve->SetLength(spCkeOffset);
		//
		HRESULT rc = PrtService::ObjectUpdate(m_spFirstPoint);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		if (FAILED(rc))
		{
			PrtService::ShowDlgNotify("错误提示","偏移值超标!");
			return;	
		}
	}
}

//
//获得长度值
void PrtFstPointsCmd::GetCurveLength()
{
	//
	if (m_spCurvePar != NULL_var)
	{
		CATIMeasurableCurve_var spMeas = m_spCurvePar;
		spMeas->GetLength(m_dLengthspCurvePar);
	} 
	else
	{
		m_dLengthspCurvePar = 0;
	}
}

// [3/8/2013 WZ4]
// 创建第一点函数，用于以后的循环创建模式
HRESULT PrtFstPointsCmd::CreateFastenerFirstPoint()
{
	//
	HRESULT rc = S_OK;
	//
	//获得文档指针
	CATIGSMFactory_var iospGSMFact = NULL_var;
	PrtService::GetGSMFactory(m_piDoc,iospGSMFact);

	//创建几何图形集
	CATISpecObject_var ospFatGSSpecObj = NULL_var;
	PrtService::ObtainGSMTool(m_piDoc,"过程元素",ospFatGSSpecObj);
	CATIPrtContainer *opiRootContainer = NULL;
	PrtService::ObtainRootContainer(m_piDoc,opiRootContainer);
	//获得part
	CATISpecObject_var spPart = opiRootContainer->GetPart();
	if (ospFatGSSpecObj == NULL_var)
	{
		//不存在则创建
		int oDiag = 0 ;
		PrtService::CAAGsiCreateGeometricFeatureSets(opiRootContainer,"过程元素",NULL_var,ospFatGSSpecObj,oDiag,1,0);
	}
	//
	//  [3/8/2013 WZ4]
	//
	CATISpecObject_var iospJointGSMTool = NULL_var;
	CATListValCATUnicodeString ilstStrPartsInstName;
	for (int i =1; i <= m_lstSpecPrds.Size(); i++)
	{
		CATIProduct_var spInsPrd = m_lstSpecPrds[i];
		CATIProduct_var spRefPrd = spInsPrd->GetReferenceProduct();

		CATUnicodeString strPrtName;
		strPrtName = spRefPrd->GetPartNumber();
		ilstStrPartsInstName.Append(strPrtName);
	}

	//找到正确的几何图形集放置点模型
	GetPartsJointGSMTool(iospJointGSMTool,ilstStrPartsInstName);
	//
	//把连接零件的PRD指针数组放入该几何图形集，确保关联性
	CATUnicodeString strKey("F_ATTEX_LINK_PRT");
	if (!PrtService::IsExistSpecObjectAttEx(strKey,iospJointGSMTool))
	{
		PrtService::SetSepcObjectAttrEx(m_lstSpecPrds,strKey,iospJointGSMTool);
	}

	//
	//创建几何图形集放置点集合
	int oDiag = 0 ;
	PrtService::CAAGsiCreateGeometricFeatureSets(opiRootContainer,"安装点集合",iospJointGSMTool,m_spPointGSMTool,oDiag,0,0);

	//创建基线
	if (m_lstSpecCurves.Size() >= 2 && m_spAssambleCurve==NULL_var)
	{
		m_spAssambleCurve = iospGSMFact->CreateAssemble(m_lstSpecCurves,NULL_var,TRUE);
		PrtService::CAAGsiInsertInProceduralView(m_spAssambleCurve,m_spPointGSMTool);
		PrtService::SetAlias(m_spAssambleCurve,"基线");
		PrtService::SetSpecObjShowAttr(m_spAssambleCurve,"Hide");
		rc = PrtService::ObjectUpdate(m_spAssambleCurve);
		if (FAILED(rc))
		{
			PrtService::ShowDlgNotify("错误提示","所选线集合非连通，请重新选择!");
			m_spAssambleCurve->GetFather()->Remove(m_spAssambleCurve);
			m_spPointGSMTool->GetFather()->Remove(m_spPointGSMTool);
			m_spPointGSMTool=NULL_var;
			m_spAssambleCurve=NULL_var;
			return E_FAIL;
		}
	}
	else if (m_lstSpecCurves.Size() == 1 && m_spAssambleCurve==NULL_var)
	{
		m_spAssambleCurve = m_lstSpecCurves[1];
	}

	//创建组合面
	if (m_lstSpecSurfs.Size() >= 2 && m_spAssembleSurfs==NULL_var)
	{
		m_spAssembleSurfs = iospGSMFact->CreateAssemble(m_lstSpecSurfs);
		PrtService::CAAGsiInsertInProceduralView(m_spAssembleSurfs,m_spPointGSMTool);
		PrtService::SetAlias(m_spAssembleSurfs,"基面");
		PrtService::SetSpecObjShowAttr(m_spAssembleSurfs,"Hide");
		PrtService::ObjectUpdate(m_spAssembleSurfs);
	} 
	else if (m_lstSpecSurfs.Size() == 1 && m_spAssembleSurfs==NULL_var)
	{
		m_spAssembleSurfs = m_lstSpecSurfs[1];
	}

	//创建平行线
	double dOffsetValue = m_pDlg->_DistanceSpinner->GetValue();
	dOffsetValue *= 1000.0;
	m_dCurveOffsetValue = dOffsetValue;
	//
	CATICkeParm_var spCkeOffset = NULL_var;
	spCkeOffset = PrtService::LocalInstLitteral(&dOffsetValue,1,"Length","Length");
	//
	m_spCurvePar = iospGSMFact->CreateCurvePar(m_spAssambleCurve,m_spAssembleSurfs,spCkeOffset,FALSE);
	//PrtService::CAAGsiInsertInProceduralView(m_spCurvePar,m_spPointGSMTool);
	PrtService::SetAlias(m_spCurvePar,"排布线");
	//PrtService::SetSpecObjShowAttr(m_spCurvePar,"Hide");
	rc = PrtService::ObjectUpdate(m_spCurvePar);
	if (FAILED(rc))
	{
		CATIGSMCurvePar_var spGSMPar = m_spCurvePar;
		spGSMPar->SetInvertDirection(TRUE);
	}
	rc = PrtService::ObjectUpdate(m_spCurvePar);
	if (FAILED(rc))
	{
		PrtService::ShowDlgNotify("错误提示","所选线在所选安装面上无法生成平行线!");
		//
		//删除已有信息
		m_spPointGSMTool->GetFather()->Remove(m_spPointGSMTool);
		//重置为NULL_var
		m_spAssambleCurve = NULL_var;
		m_spAssembleSurfs = NULL_var;
		m_spRefPoint=NULL_var;
		m_spFirstPoint=NULL_var;
		m_spPointGSMTool=NULL_var;
		m_spCurvePar=NULL_var;		
		//
		return E_FAIL;	
	}
	//
	if (IsClosedCircle(m_spAssambleCurve))
	{
		//PrtService::ShowDlgNotify("提示","是闭合曲线！");
		//采用极值点模式
		double dDisToRefValue = m_pDlg->_DisToRefSpinner->GetValue();
		dDisToRefValue *= 1000.0;
		CATICkeParm_var spCkedLengthValue = NULL_var;
		spCkedLengthValue = PrtService::LocalInstLitteral(&dDisToRefValue,1,"Length","Length");
		m_spFirstPoint = iospGSMFact->CreatePoint(m_spCurvePar,NULL_var,spCkedLengthValue,CATGSMSameOrientation);
		//
		PrtService::CAAGsiInsertInProceduralView(m_spFirstPoint,m_spPointGSMTool);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		//
		CATIGSMDirection_var spGSMDir = iospGSMFact->CreateDirection(NULL_var,NULL_var,NULL_var);
		spGSMDir->SetCoordinates(1,2,3);
		spGSMDir->SetLocalCoordinates(-2,1,0);
		//
		m_spRefPoint = iospGSMFact->CreateExtremum(m_spCurvePar,spGSMDir,GSMMax);
		//
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spFirstPoint;
		spGSMPointOnCurve->SetReferencePoint(m_spRefPoint);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		//
		PrtService::HighlightHSO(m_spCurvePar);
		//
	} 
	else
	{
		//采用Ratio模式
		double dDisToRefValue = m_pDlg->_DisToRefSpinner->GetValue();
		dDisToRefValue *= 1000.0;
		CATICkeParm_var spCkedLengthValue = NULL_var;
		spCkedLengthValue = PrtService::LocalInstLitteral(&dDisToRefValue,1,"Length","Length");
		m_spFirstPoint = iospGSMFact->CreatePoint(m_spCurvePar,NULL_var,spCkedLengthValue,CATGSMSameOrientation);
		//
		PrtService::CAAGsiInsertInProceduralView(m_spFirstPoint,m_spPointGSMTool);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		//
		double dRatioValue = 0;
		CATICkeParm_var spCkedRatioValue = NULL_var;
		spCkedRatioValue = PrtService::LocalInstLitteral(&dRatioValue,1,"Real","Ratio");
		m_spRefPoint = iospGSMFact->CreatePoint(m_spCurvePar,NULL_var,spCkedRatioValue,CATGSMSameOrientation);
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = m_spFirstPoint;
		spGSMPointOnCurve->SetReferencePoint(m_spRefPoint);
		rc = PrtService::ObjectUpdate(m_spFirstPoint);
		//
		PrtService::HighlightHSO(m_spCurvePar);
		//	
	}
	//
	return S_OK;	
}

//
//  [3/8/2013 WZ4]
//获取放置点线模型的零件几何图形集
void PrtFstPointsCmd::GetPartsJointGSMTool(CATISpecObject_var &iospJointGSMTool,CATListValCATUnicodeString ilstStrPartsInstName)
{
	//获取所有该几何集下面所有的二级子集
	CATISpecObject_var spLineDefGSMTool = NULL_var;
	PrtService::ObtainGSMTool(m_piDoc,"过程元素",spLineDefGSMTool);
	if (spLineDefGSMTool == NULL_var)
	{
		//获得文档指针
		CATIPrtContainer *opiRootContainer = NULL;
		PrtService::ObtainRootContainer(m_piDoc,opiRootContainer);
		//不存在则创建
		int oDiag = 0 ;
		PrtService::CAAGsiCreateGeometricFeatureSets(opiRootContainer,"过程元素",NULL_var,spLineDefGSMTool,oDiag,1,0);
	}
	CATListValCATISpecObject_var iolstspFoundResult;
	PrtService::SearchALLSonFromRootGSMTool(spLineDefGSMTool,iolstspFoundResult);

	//解析这些几何图形集的名称，找到匹配名字的那个
	CATBoolean IsGetTheOne = FALSE;
	for (int i=1; i <= iolstspFoundResult.Size(); i++)
	{
		CATListValCATUnicodeString lststrResult;
		CATUnicodeString strAlias = PrtService::GetAlias(iolstspFoundResult[i]);
		CHandleString::StringToVector(strAlias,"|",lststrResult);

		//先判断个数
		if (lststrResult.Size() == ilstStrPartsInstName.Size())
		{
			//
			CATListValCATUnicodeString lstIsOrNot;
			//
			for (int j = 1; j <= lststrResult.Size(); j ++)
			{
				for (int n = 1; n <= ilstStrPartsInstName.Size(); n ++ )
				{
					if (lststrResult[j] == ilstStrPartsInstName[n])
					{
						lstIsOrNot.Append("1");
						break;
					}
					//
					if (n == ilstStrPartsInstName.Size())
					{
						lstIsOrNot.Append("0");
					}
				}
			}
			//
			CATBoolean IsRight=TRUE;
			for (int n=1; n<=lstIsOrNot.Size(); n++)
			{
				if (lstIsOrNot[n]=="0")
				{
					IsRight = FALSE;
					break;
				}
			}
			//
			if (IsRight == TRUE)
			{
				iospJointGSMTool = iolstspFoundResult[i];
				IsGetTheOne = TRUE;
				break;
			}
		} 
		else //直接跳过
		{
			continue;
		}
	}

	//所有查询后未发现需要的信息时，自动根据输入创建一个几何图形集
	if (IsGetTheOne == FALSE)
	{
		//创建点线模型几何图形集
		CATUnicodeString strPartsJointName;
		for (int i=1; i <= ilstStrPartsInstName.Size(); i++)
		{
			strPartsJointName += ilstStrPartsInstName[i];
			if (i != ilstStrPartsInstName.Size())
			{
				strPartsJointName += "|";
			}
		}
		//不存在则创建
		CATIPrtContainer *opiRootContainer = NULL;
		PrtService::ObtainRootContainer(m_piDoc,opiRootContainer);
		int oDiag = 0 ;
		PrtService::CAAGsiCreateGeometricFeatureSets(opiRootContainer,strPartsJointName,spLineDefGSMTool,iospJointGSMTool,oDiag,0,0);
	}
}
//
//核心算法，比较始点终点相对参考点的坐标位置信息
void PrtFstPointsCmd::CalculateStartEndPointInfo()
{
	//
	if (m_pDlg->_RefPointEditor->GetText() != "Middle") //如果是Start Extremity、End Extremity、Extremum模式
	{
		//Start Extremity、End Extremity
		if (m_pDlg->_RefPointEditor->GetText() == m_pRepeatPanelDlg->_RefEndPointExtremityEditor->GetText())
		{
			double dValue01,dValue02;
			dValue01 = m_pDlg->_DisToRefSpinner->GetValue() * 1000.0;
			dValue02 = m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->GetValue() * 1000.0;
			//
			m_dLengthEndToStart = dValue02-dValue01;
		} 
		else
		{
			//
			double dValue01,dValue02;
			dValue01 = m_pDlg->_DisToRefSpinner->GetValue() * 1000.0;
			dValue02 = m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->GetValue() * 1000.0;
			//
			m_dLengthEndToStart = m_dLengthspCurvePar - dValue02 - dValue01;
		}
		//
		((CATIGSMPointOnCurve_var)m_spFirstPoint)->GetOrientation(m_GSMOrientFirstPoint);

	} 
	else //其它模式Middle
	{
		//
		CATGSMOrientation iOrientationStart,oOrientationEnd; 
		//
		if (m_pRepeatPanelDlg->_RefEndPointExtremityEditor->GetText() == "Start Extremity")
		{
			oOrientationEnd = CATGSMSameOrientation;
		} 
		else
		{
			oOrientationEnd = CATGSMInvertOrientation;
		}
		//
		((CATIGSMPointOnCurve_var)m_spFirstPoint)->GetOrientation(iOrientationStart);
		m_GSMOrientFirstPoint = iOrientationStart;
		//
		if (iOrientationStart == oOrientationEnd) //如果同向
		{
			//
			double dValue01,dValue02;
			dValue01 = m_pDlg->_DisToRefSpinner->GetValue() * 1000.0;
			dValue02 = m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->GetValue() * 1000.0;
			//
			m_dLengthEndToStart = dValue02 - dValue01 - m_dLengthspCurvePar*0.5;
		} 
		else //如果异向
		{
			//
			double dValue01,dValue02;
			dValue01 = m_pDlg->_DisToRefSpinner->GetValue() * 1000.0;
			dValue02 = m_pRepeatPanelDlg->_SpaceToRefEndPointSpinner->GetValue() * 1000.0;
			//
			m_dLengthEndToStart = m_dLengthspCurvePar*0.5 - dValue02 - dValue01;			
		}

	}
}

//创建高亮显示虚拟点位置信息
void PrtFstPointsCmd::HighLightPreviewPoint(double  iLength, CATMathPoint&  ioResultPoint)
{
	//
	CATBody *piWireBody = NULL,*piResultBody = NULL;
	//
	// defines an open configuration for the operator
	CATSoftwareConfiguration * pConfig = new CATSoftwareConfiguration();
	// defines the data of the operator: configuration + journal
	CATTopData topdata(pConfig,NULL);
	//
	//获得输入曲线的拓扑
	CATIGeometricalElement_var spGeomEle01 = m_spCurvePar;
	CATBody_var spWireBody = spGeomEle01->GetBodyResult();	
	//获得参考点的拓扑
	CATIGeometricalElement_var spGeomEle02 = m_spFirstPoint;
	CATBody_var spRefPointBody = spGeomEle02->GetBodyResult();
	//
	CATGeoFactory* iFactory = spWireBody->GetFactory();
	//
	//获得曲线上点位置信息的拓扑
	CATBody * piTopPointOnWire = CATCreateTopPointOnWire(iFactory,&topdata,spWireBody,iLength,spRefPointBody,CatTopPointLMode::CatTopPointLValue);
	//获取BODY结果
	CATLISTP(CATCell) ioResult01;
	piTopPointOnWire->GetAllCells(ioResult01,0);
	CATVertex* pVertex01 = (CATVertex*)ioResult01[1];
	CATPoint* pPoint01=pVertex01->GetPoint();
	pPoint01->GetMathPoint(ioResultPoint);
	//
	//去除内存
	CATICGMContainer * piContainer = spWireBody->GetContainer();
	piContainer->Remove(piTopPointOnWire);
}

//
//预览Repeat Panel Point 模式按钮
void PrtFstPointsCmd::OnRepeatPanelPreviewPBCB(CATCommand* cmd, CATNotification* evt, CATCommandClientData data)
{
	//
	m_piISO->Empty();
	m_piHSO->Empty();
	//
	m_piISO->AddElement(m_spCurvePar);
	//计算当前长度，方向等参考信息
	CalculateStartEndPointInfo();

	// 获取Repeat Panel界面的参数信息
	if (m_pRepeatPanelDlg->m_IChoosedIndex == 0)
	{
		//
		double dStepValue = 0;
		//安装点个数模式
		double dCount = m_pRepeatPanelDlg->_InstancesSpinner->GetValue();
		//
		if (m_pRepeatPanelDlg->_CheckB->GetState() == CATDlgCheck && dCount != 1)
		{
			//
			dStepValue = m_dLengthEndToStart / (dCount-1);						
		} 
		else
		{
			//
			dStepValue = m_dLengthEndToStart / dCount;
		}
		//
		//显示安装点位置信息
		//
		for (int i = 0; i < dCount; i++)
		{
			//
			CATMathPoint  ioResultPoint;
			if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
			{
				HighLightPreviewPoint(dStepValue*i,ioResultPoint);
			} 
			else
			{
				HighLightPreviewPoint(-dStepValue*i,ioResultPoint);
			}
			
			//
			CATUnicodeString StrTextValue;
			StrTextValue.BuildFromNum(i+1);
			//
			CATMathPointf TextPosNode;
			TextPosNode.x = (float)(ioResultPoint.GetX());
			TextPosNode.y = (float)(ioResultPoint.GetY());
			TextPosNode.z = (float)(ioResultPoint.GetZ());
			//
			CAT3DCustomRep * pRepForTextStart= new CAT3DCustomRep();
			CATGraphicAttributeSet   TextGaNode ;
			TextGaNode.SetColor(BLUE);
			CAT3DAnnotationTextGP   *pTextGPSrart = new CAT3DAnnotationTextGP(TextPosNode,StrTextValue);
			pRepForTextStart->AddGP(pTextGPSrart,TextGaNode);
			//
			CAT3DPointRep *p3DPoint = new CAT3DPointRep(TextPosNode,STAR);
			p3DPoint->SetColor(GREEN);
			//
			CAT3DBagRep *pi3DBagRep = new CAT3DBagRep(); 
			pi3DBagRep->AddChild(*pRepForTextStart);
			pi3DBagRep->AddChild(*p3DPoint);
			//	
			CATModelForRep3D *piRepPtAlias = new CATModelForRep3D();
			piRepPtAlias->SetRep(pi3DBagRep) ;
			m_piISO->AddElement(piRepPtAlias);

			piRepPtAlias->Release();
			piRepPtAlias=NULL;
		}

	} 
	else if (m_pRepeatPanelDlg->m_IChoosedIndex == 1)
	{
		//安装点间距模式
		//个数&间距模式
		double dStepValue = m_pRepeatPanelDlg->_PitchSpinner->GetValue()*1000;
		//安装点个数模式
		double dCount = (int)(m_dLengthEndToStart/dStepValue)+1;
		//
		if (m_pRepeatPanelDlg->_CheckB->GetState() == CATDlgUncheck && dCount != 1)
		{
			//
			dCount -= 1;						
		} 
		//
		if (m_pRepeatPanelDlg->_BestFitCheckB->GetState() == CATDlgCheck)
		{
			int iCount =  (int)(m_dLengthEndToStart/dStepValue);
			if (iCount != 0)
			{
				dStepValue = m_dLengthEndToStart/iCount;
				//
				CATUnicodeString str; str.BuildFromNum(dStepValue);
				str += "mm";
				m_pRepeatPanelDlg->_BestFitEditor->SetText(str);
			}			
		}
		
		//显示安装点位置信息
		//
		for (int i = 0; i < dCount; i++)
		{
			//
			CATMathPoint  ioResultPoint;
			if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
			{
				HighLightPreviewPoint(dStepValue*i,ioResultPoint);
			} 
			else
			{
				HighLightPreviewPoint(-dStepValue*i,ioResultPoint);
			}

			//
			CATUnicodeString StrTextValue;
			StrTextValue.BuildFromNum(i+1);
			//
			CATMathPointf TextPosNode;
			TextPosNode.x = (float)(ioResultPoint.GetX());
			TextPosNode.y = (float)(ioResultPoint.GetY());
			TextPosNode.z = (float)(ioResultPoint.GetZ());
			//
			CAT3DCustomRep * pRepForTextStart= new CAT3DCustomRep();
			CATGraphicAttributeSet   TextGaNode ;
			TextGaNode.SetColor(BLUE);
			CAT3DAnnotationTextGP   *pTextGPSrart = new CAT3DAnnotationTextGP(TextPosNode,StrTextValue);
			pRepForTextStart->AddGP(pTextGPSrart,TextGaNode);
			//
			CAT3DPointRep *p3DPoint = new CAT3DPointRep(TextPosNode,STAR);
			p3DPoint->SetColor(GREEN);
			//
			CAT3DBagRep *pi3DBagRep = new CAT3DBagRep(); 
			pi3DBagRep->AddChild(*pRepForTextStart);
			pi3DBagRep->AddChild(*p3DPoint);
			//	
			CATModelForRep3D *piRepPtAlias = new CATModelForRep3D();
			piRepPtAlias->SetRep(pi3DBagRep) ;
			m_piISO->AddElement(piRepPtAlias);

			piRepPtAlias->Release();
			piRepPtAlias=NULL;
		}
	} 
	else if (m_pRepeatPanelDlg->m_IChoosedIndex == 2)
	{
		//个数&间距模式
		double dStepValue = m_pRepeatPanelDlg->_PitchSpinner->GetValue()*1000;
		//安装点个数模式
		double dCount = m_pRepeatPanelDlg->_InstancesSpinner->GetValue();
		//显示安装点位置信息
		//
		for (int i = 0; i < dCount; i++)
		{
			//
			CATMathPoint  ioResultPoint;
			if (m_GSMOrientFirstPoint == CATGSMSameOrientation)
			{
				HighLightPreviewPoint(dStepValue*i,ioResultPoint);
			} 
			else
			{
				HighLightPreviewPoint(-dStepValue*i,ioResultPoint);
			}

			//
			CATUnicodeString StrTextValue;
			StrTextValue.BuildFromNum(i+1);
			//
			CATMathPointf TextPosNode;
			TextPosNode.x = (float)(ioResultPoint.GetX());
			TextPosNode.y = (float)(ioResultPoint.GetY());
			TextPosNode.z = (float)(ioResultPoint.GetZ());
			//
			CAT3DCustomRep * pRepForTextStart= new CAT3DCustomRep();
			CATGraphicAttributeSet   TextGaNode ;
			TextGaNode.SetColor(BLUE);
			CAT3DAnnotationTextGP   *pTextGPSrart = new CAT3DAnnotationTextGP(TextPosNode,StrTextValue);
			pRepForTextStart->AddGP(pTextGPSrart,TextGaNode);
			//
			CAT3DPointRep *p3DPoint = new CAT3DPointRep(TextPosNode,STAR);
			p3DPoint->SetColor(GREEN);
			//
			CAT3DBagRep *pi3DBagRep = new CAT3DBagRep(); 
			pi3DBagRep->AddChild(*pRepForTextStart);
			pi3DBagRep->AddChild(*p3DPoint);
			//	
			CATModelForRep3D *piRepPtAlias = new CATModelForRep3D();
			piRepPtAlias->SetRep(pi3DBagRep) ;
			m_piISO->AddElement(piRepPtAlias);

			piRepPtAlias->Release();
			piRepPtAlias=NULL;
		}

	}	
}


HRESULT PrtFstPointsCmd::CreateResultPoints(double iLength, CATGSMOrientation GSMOrientRef)
{
	//
	HRESULT rc = S_OK;
	//
	//获得文档指针
	CATIGSMFactory_var iospGSMFact = NULL_var;
	PrtService::GetGSMFactory(m_piDoc,iospGSMFact);
	//
	//创建平行线
	double dOffsetValue = m_pDlg->_DistanceSpinner->GetValue();
	dOffsetValue *= 1000.0;
	//
	CATICkeParm_var spCkeOffset = NULL_var;
	spCkeOffset = PrtService::LocalInstLitteral(&dOffsetValue,1,"Length","Length");
	//
	CATBoolean oInvert;
	CATIGSMCurvePar_var spFirstGSMPar = m_spCurvePar;
	spFirstGSMPar->GetInvertDirection(oInvert);	
	//
	CATISpecObject_var spCurvePar = iospGSMFact->CreateCurvePar(m_spAssambleCurve,m_spAssembleSurfs,spCkeOffset,oInvert);
	PrtService::SetAlias(spCurvePar,"排布线");
	rc = PrtService::ObjectUpdate(spCurvePar);
	//
	if (IsClosedCircle(m_spAssambleCurve))
	{
		//采用极值点模式
		CATICkeParm_var spCkedLengthValue = NULL_var;
		spCkedLengthValue = PrtService::LocalInstLitteral(&iLength,1,"Length","Length");
		CATISpecObject_var spFastenerPoint = iospGSMFact->CreatePoint(spCurvePar,NULL_var,spCkedLengthValue,GSMOrientRef);
		//
		PrtService::CAAGsiInsertInProceduralView(spFastenerPoint,m_spPointGSMTool);
		rc = PrtService::ObjectUpdate(spFastenerPoint);
		//
		CATIGSMDirection_var spGSMDir = iospGSMFact->CreateDirection(NULL_var,NULL_var,NULL_var);
		spGSMDir->SetCoordinates(1,2,3);
		spGSMDir->SetLocalCoordinates(-2,1,0);
		//
		CATISpecObject_var spRefPoint = iospGSMFact->CreateExtremum(spCurvePar,spGSMDir,GSMMax);
		//
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = spFastenerPoint;
		spGSMPointOnCurve->SetReferencePoint(spRefPoint);
		rc = PrtService::ObjectUpdate(spFastenerPoint);
	} 
	else
	{
		//采用Ratio模式
		CATICkeParm_var spCkedLengthValue = NULL_var;
		spCkedLengthValue = PrtService::LocalInstLitteral(&iLength,1,"Length","Length");
		CATISpecObject_var spFastenerPoint = iospGSMFact->CreatePoint(spCurvePar,NULL_var,spCkedLengthValue,GSMOrientRef);
		//
		PrtService::CAAGsiInsertInProceduralView(spFastenerPoint,m_spPointGSMTool);
		rc = PrtService::ObjectUpdate(spFastenerPoint);
		//
		double dRatioValue = 0;
		CATICkeParm_var oDistance;
		CATIGSMPointOnCurve_var spFirstRefPoint = m_spRefPoint;
		spFirstRefPoint->GetLength(oDistance);
		CATICkeInst_var CkeValue = oDistance->Value();
		dRatioValue = CkeValue->AsReal();
		//
		CATICkeParm_var spCkedRatioValue = NULL_var;
		spCkedRatioValue = PrtService::LocalInstLitteral(&dRatioValue,1,"Real","Ratio");
		CATISpecObject_var spRefPoint = iospGSMFact->CreatePoint(spCurvePar,NULL_var,spCkedRatioValue,GSMOrientRef);
		//
		CATIGSMPointOnCurve_var spGSMPointOnCurve = spFastenerPoint;
		spGSMPointOnCurve->SetReferencePoint(spRefPoint);
		rc = PrtService::ObjectUpdate(spFastenerPoint);
	}
	//
	return rc;	
}

//获得传入特征的的父级节点
HRESULT PrtFstPointsCmd::GetLinkImportPrd(CATISpecObject_var& ispFeature,CATIProduct_var &ospSourcePrd)
{
	HRESULT rc = S_OK;
	ospSourcePrd=NULL_var;
	CATIMmiMechanicalImportApplicative* piLinkImport = NULL;
	//
	rc = ispFeature->QueryInterface(IID_CATIMmiMechanicalImportApplicative,(void**)&piLinkImport);
	//
	if (SUCCEEDED(rc) && (piLinkImport!=NULL))
	{
		CATIProduct_var spSourcePrd = NULL_var;
		piLinkImport->GetSourceProduct(ospSourcePrd);
		//
		piLinkImport->Release();
		piLinkImport=NULL;
	}
	
	return rc;
}
//判断一个曲面特征是否在另一个数组中
BOOL PrtFstPointsCmd::IsTheSpecInLstSpec(CATISpecObject_var iSpec, CATListValCATISpecObject_var iLstSpec)
{
	for (int i = 1; i <= iLstSpec.Size(); i ++)
	{
		if (iSpec == iLstSpec[i])
		{
			return TRUE;
		}
	}

	return FALSE;		
}